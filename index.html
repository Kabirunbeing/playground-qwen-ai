<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Unreal Playground</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

  <style>
    :root {
      --bg-primary: #0a0a1a;
      --bg-secondary: #121432;
      --bg-tertiary: #1a1c42;
      --accent-primary: #00aaff;
      --accent-secondary: #8a2be2;
      --accent-tertiary: #00ffaa;
      --text-primary: #e0e0ff;
      --text-secondary: #a0a0c0;
      --border-radius: 12px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --shadow-primary: 0 8px 32px rgba(0, 170, 255, 0.15);
      --shadow-secondary: 0 4px 16px rgba(138, 43, 226, 0.1);
      --header-height: 60px;
      --control-padding: 12px;
      --panel-padding: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: linear-gradient(135deg, var(--bg-primary), #0f1530);
      color: var(--text-primary);
      min-height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      touch-action: manipulation;
    }

    .app-container {
      height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    header {
      height: var(--header-height);
      padding: 0 var(--panel-padding);
      background: rgba(10, 10, 26, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 170, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      z-index: 10;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .logo h1 {
      font-family: 'Orbitron', sans-serif;
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: 0.5px;
    }

    .logo-icon {
      color: var(--accent-primary);
      font-size: 22px;
      animation: pulse 2s infinite;
    }

    .controls {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 12px;
      border-radius: 8px;
      border: none;
      font-family: 'Roboto', sans-serif;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
      min-height: 40px;
    }

    .btn-primary {
      background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      box-shadow: var(--shadow-primary);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
    }

    .btn-secondary {
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-primary);
      border: 1px solid rgba(0, 170, 255, 0.3);
    }

    .btn-secondary:hover {
      background: rgba(0, 170, 255, 0.15);
    }

    .btn-icon {
      padding: 8px;
      font-size: 14px;
    }

    /* Main Content */
    .main-content {
      display: flex;
      flex: 1;
      overflow: hidden;
      padding: 12px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .editor-section, .preview-section {
      flex: 1;
      min-width: 300px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    /* Tabs */
    .editor-tabs {
      display: flex;
      background: rgba(26, 28, 66, 0.6);
      border-radius: var(--border-radius);
      padding: 4px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 170, 255, 0.2);
      overflow-x: auto;
      white-space: nowrap;
      scrollbar-width: none;
    }

    .editor-tabs::-webkit-scrollbar {
      display: none;
    }

    .tab {
      padding: 10px 14px;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      font-size: 14px;
      min-width: 90px;
      transition: var(--transition);
    }

    .tab.active {
      background: rgba(0, 170, 255, 0.2);
      color: var(--accent-primary);
    }

    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -4px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--accent-primary);
      border-radius: 1px;
    }

    .tab:hover:not(.active) {
      background: rgba(255, 255, 255, 0.05);
    }

    .language-icon {
      margin-right: 6px;
      font-size: 15px;
    }

    /* Editor */
    .editor-container {
      flex: 1;
      background: rgba(18, 20, 50, 0.6);
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 1px solid rgba(0, 170, 255, 0.2);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-secondary);
      display: flex;
      flex-direction: column;
    }

    .editor-header {
      padding: 10px var(--panel-padding);
      background: rgba(10, 10, 26, 0.8);
      border-bottom: 1px solid rgba(0, 170, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .editor-title {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .editor-actions {
      display: flex;
      gap: 6px;
    }

    .action-btn {
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-secondary);
      width: 30px;
      height: 30px;
      border-radius: 6px;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .action-btn:hover {
      background: rgba(0, 170, 255, 0.2);
      color: var(--accent-primary);
    }

    .editor {
      flex: 1;
      padding: var(--panel-padding);
      font-family: 'Courier New', monospace;
      font-size: 14px;
      line-height: 1.5;
      color: var(--text-primary);
      background: transparent;
      resize: none;
      outline: none;
      overflow-y: auto;
      border: none;
    }

    /* Preview */
    .preview-header {
      padding: 10px var(--panel-padding);
      background: rgba(26, 28, 66, 0.6);
      border-radius: var(--border-radius);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 170, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
    }

    .preview-title {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .device-controls {
      display: flex;
      gap: 6px;
    }

    .device-btn {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }

    .device-btn.active, .device-btn:hover {
      background: rgba(0, 170, 255, 0.2);
      color: var(--accent-primary);
    }

    .preview-frame {
      flex: 1;
      background: rgba(26, 28, 66, 0.6);
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 1px solid rgba(0, 170, 255, 0.2);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-secondary);
    }

    .preview {
      width: 100%;
      height: 100%;
      border: none;
      background: white;
    }

    /* Console */
    .console-section {
      height: 180px;
      background: rgba(26, 28, 66, 0.6);
      border-radius: var(--border-radius);
      overflow: hidden;
      border: 1px solid rgba(0, 170, 255, 0.2);
      backdrop-filter: blur(10px);
      box-shadow: var(--shadow-secondary);
      display: flex;
      flex-direction: column;
    }

    .console-header {
      padding: 10px var(--panel-padding);
      background: rgba(10, 10, 26, 0.8);
      border-bottom: 1px solid rgba(0, 170, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .console-title {
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 13px;
    }

    .console-controls {
      display: flex;
      gap: 6px;
    }

    .console {
      flex: 1;
      padding: var(--panel-padding);
      font-family: 'Courier New', monospace;
      font-size: 13px;
      background: transparent;
      color: var(--text-primary);
      overflow-y: auto;
    }

    .log-entry {
      margin-bottom: 6px;
      padding-left: 12px;
      border-left: 2px solid transparent;
      opacity: 0.9;
    }

    .log-info { border-left-color: var(--accent-primary); }
    .log-warning { border-left-color: #ffa500; }
    .log-error { border-left-color: #ff3366; }

    /* Snippets Panel */
    .snippets-panel {
      position: fixed;
      right: 16px;
      bottom: 16px;
      width: 300px;
      height: 400px;
      background: rgba(10, 10, 26, 0.95);
      backdrop-filter: blur(12px);
      border-radius: var(--border-radius);
      border: 1px solid rgba(0, 170, 255, 0.2);
      box-shadow: var(--shadow-primary);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      opacity: 0;
      pointer-events: none;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .snippets-panel.open {
      transform: translateY(0);
      opacity: 1;
      pointer-events: auto;
    }

    .snippets-header {
      padding: var(--panel-padding);
      background: rgba(18, 20, 50, 0.6);
      border-bottom: 1px solid rgba(0, 170, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: var(--border-radius) var(--border-radius) 0 0;
    }

    .snippets-title {
      font-weight: 500;
      font-size: 14px;
    }

    .close-snippets {
      background: none;
      border: none;
      color: var(--text-secondary);
      font-size: 16px;
      cursor: pointer;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      transition: var(--transition);
    }

    .close-snippets:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--accent-primary);
    }

    .snippets-content {
      flex: 1;
      padding: var(--panel-padding);
      overflow-y: auto;
      font-size: 14px;
    }

    .snippet-item {
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: rgba(26, 28, 66, 0.6);
      border: 1px solid rgba(0, 170, 255, 0.1);
      cursor: pointer;
      transition: var(--transition);
    }

    .snippet-item:hover {
      background: rgba(0, 170, 255, 0.1);
      transform: translateX(4px);
    }

    .snippet-title {
      font-weight: 500;
      margin-bottom: 4px;
      font-size: 14px;
    }

    .snippet-desc {
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Floating Button */
    .floating-btn {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
      color: white;
      border: none;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(0, 170, 255, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      transition: var(--transition);
      z-index: 900;
      touch-action: manipulation;
    }

    .floating-btn:hover, .floating-btn:active {
      transform: translateY(-3px) scale(1.05);
      box-shadow: 0 12px 32px rgba(0, 170, 255, 0.5);
    }

    /* Animations */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }

    /* Responsive Design */
    @media (max-width: 768px) {
      :root {
        --header-height: 52px;
        --panel-padding: 12px;
        --control-padding: 8px;
      }

      header {
        padding: 0 var(--panel-padding);
        height: var(--header-height);
      }

      .logo h1 {
        font-size: 16px;
      }

      .logo-icon {
        font-size: 20px;
      }

      .btn {
        padding: 6px 10px;
        font-size: 12px;
        min-height: 36px;
      }

      .btn-icon {
        padding: 6px;
      }

      .main-content {
        padding: 10px;
        gap: 10px;
        flex-direction: column;
      }

      .editor-section, .preview-section {
        min-width: 100%;
        height: auto;
      }

      .editor-tabs {
        font-size: 13px;
      }

      .tab {
        padding: 8px 10px;
        min-width: 80px;
        font-size: 13px;
      }

      .editor-header, .preview-header, .console-header {
        padding: 8px var(--panel-padding);
        font-size: 12px;
      }

      .editor-title, .preview-title, .console-title {
        gap: 4px;
        font-size: 12px;
      }

      .editor {
        padding: var(--panel-padding);
        font-size: 13px;
      }

      .console {
        font-size: 12px;
      }

      .action-btn, .device-btn {
        width: 28px;
        height: 28px;
        font-size: 13px;
      }

      .floating-btn {
        width: 46px;
        height: 46px;
        bottom: 16px;
        right: 16px;
        font-size: 16px;
      }

      .snippets-panel {
        width: 280px;
        height: 360px;
        right: 12px;
        bottom: 12px;
      }

      .snippets-header {
        padding: 10px;
      }

      .snippets-content {
        padding: 10px;
      }

      .snippet-item {
        padding: 8px;
      }

      .snippet-title {
        font-size: 13px;
      }

      .snippet-desc {
        font-size: 11px;
      }
    }

    @media (max-width: 480px) {
      :root {
        --header-height: 50px;
        --panel-padding: 10px;
      }

      .logo h1 {
        font-size: 15px;
      }

      .btn {
        padding: 5px 8px;
        font-size: 11px;
        min-height: 32px;
      }

      .editor, .console {
        font-size: 12px;
        padding: 8px;
      }

      .tab {
        padding: 6px 8px;
        font-size: 12px;
      }

      .action-btn, .device-btn {
        width: 26px;
        height: 26px;
        font-size: 12px;
      }

      .floating-btn {
        width: 44px;
        height: 44px;
        font-size: 15px;
      }

      .snippets-panel {
        width: 260px;
        height: 320px;
      }

      .snippets-title {
        font-size: 13px;
      }
    }

    /* Landscape Mobile */
    @media (max-height: 500px) and (orientation: landscape) {
      .main-content {
        flex-direction: row;
        overflow: auto;
      }
      .console-section {
        height: 120px;
      }
    }

    /* Prevent zoom on focus */
    input, textarea, select, button {
      -webkit-user-select: text;
      -webkit-tap-highlight-color: transparent;
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="logo">
        <i class="fas fa-code logo-icon"></i>
        <h1>Unreal Playground</h1>
      </div>
      <div class="controls">
        <button id="runBtn" class="btn btn-primary">
          <i class="fas fa-play"></i> Run
        </button>
        <button id="formatBtn" class="btn btn-secondary">
          <i class="fas fa-scroll"></i> Format
        </button>
        <button id="saveBtn" class="btn btn-secondary">
          <i class="fas fa-save"></i> Save
        </button>
        <button id="snippetsBtn" class="btn btn-icon">
          <i class="fas fa-th"></i>
        </button>
      </div>
    </header>

    <div class="main-content">
      <!-- Editor Section -->
      <div class="editor-section">
        <div class="editor-tabs">
          <div class="tab active" data-lang="html">
            <i class="fab fa-html5 language-icon html-icon"></i> HTML
          </div>
          <div class="tab" data-lang="css">
            <i class="fab fa-css3-alt language-icon css-icon"></i> CSS
          </div>
          <div class="tab" data-lang="javascript">
            <i class="fab fa-js language-icon js-icon"></i> JS
          </div>
        </div>
        <div class="editor-container">
          <div class="editor-header">
            <div class="editor-title">
              <i class="fas fa-file-code"></i>
              <span id="editorMode">HTML Editor</span>
            </div>
            <div class="editor-actions">
              <button class="action-btn" id="undoBtn">
                <i class="fas fa-undo"></i>
              </button>
              <button class="action-btn" id="redoBtn">
                <i class="fas fa-redo"></i>
              </button>
              <button class="action-btn" id="clearBtn">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          <textarea id="editor" class="editor" spellcheck="false"></textarea>
        </div>
      </div>

      <!-- Preview Section -->
      <div class="preview-section">
        <div class="preview-header">
          <div class="preview-title">
            <i class="fas fa-desktop"></i> Preview
          </div>
          <div class="device-controls">
            <button class="device-btn active" data-device="desktop">
              <i class="fas fa-desktop"></i>
            </button>
            <button class="device-btn" data-device="tablet">
              <i class="fas fa-tablet-alt"></i>
            </button>
            <button class="device-btn" data-device="mobile">
              <i class="fas fa-mobile-alt"></i>
            </button>
          </div>
        </div>
        <div class="preview-frame">
          <iframe id="preview" class="preview" sandbox="allow-scripts"></iframe>
        </div>
        <div class="console-section">
          <div class="console-header">
            <div class="console-title">
              <i class="fas fa-terminal"></i> Console
            </div>
            <div class="console-controls">
              <button id="clearConsole" class="btn btn-secondary" style="font-size:12px;padding:4px 8px;">
                <i class="fas fa-trash"></i> Clear
              </button>
            </div>
          </div>
          <div id="console" class="console"></div>
        </div>
      </div>
    </div>

    <!-- Snippets Panel -->
    <div id="snippetsPanel" class="snippets-panel">
      <div class="snippets-header">
        <div class="snippets-title">Snippets</div>
        <button class="close-snippets" id="closeSnippets">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div class="snippets-content" id="snippetsContent">
        <div class="snippet-item" data-snippet="hello-world">
          <div class="snippet-title">Hello World</div>
          <div class="snippet-desc">Basic HTML structure with a greeting</div>
        </div>
        <div class="snippet-item" data-snippet="flex-container">
          <div class="snippet-title">Flex Container</div>
          <div class="snippet-desc">Responsive flexbox layout</div>
        </div>
        <div class="snippet-item" data-snippet="gradient-button">
          <div class="snippet-title">Gradient Button</div>
          <div class="snippet-desc">Animated gradient button</div>
        </div>
        <div class="snippet-item" data-snippet="modal-dialog">
          <div class="snippet-title">Modal Dialog</div>
          <div class="snippet-desc">JS-powered modal window</div>
        </div>
        <div class="snippet-item" data-snippet="animated-loader">
          <div class="snippet-title">Animated Loader</div>
          <div class="snippet-desc">CSS spinner animation</div>
        </div>
      </div>
    </div>

    <!-- Floating Action Button -->
    <button id="librariesBtn" class="floating-btn" title="Add Libraries">
      <i class="fas fa-plug"></i>
    </button>
  </div>

  <script>
    // (Same JavaScript as before â€“ no changes needed for responsiveness)
    // All responsiveness is handled via CSS and viewport meta tag
    const editor = document.getElementById('editor');
    const preview = document.getElementById('preview');
    const consoleEl = document.getElementById('console');
    const runBtn = document.getElementById('runBtn');
    const formatBtn = document.getElementById('formatBtn');
    const saveBtn = document.getElementById('saveBtn');
    const snippetsBtn = document.getElementById('snippetsBtn');
    const snippetsPanel = document.getElementById('snippetsPanel');
    const closeSnippets = document.getElementById('closeSnippets');
    const snippetsContent = document.getElementById('snippetsContent');
    const clearConsole = document.getElementById('clearConsole');
    const librariesBtn = document.getElementById('librariesBtn');
    const tabs = document.querySelectorAll('.tab');
    const deviceBtns = document.querySelectorAll('.device-btn');
    const editorMode = document.getElementById('editorMode');
    const undoBtn = document.getElementById('undoBtn');
    const redoBtn = document.getElementById('redoBtn');
    const clearBtn = document.getElementById('clearBtn');

    let currentLang = 'html';
    let editorHistory = [];
    let historyIndex = -1;

    const initialContent = {
      html: '<!DOCTYPE html>\n<html lang="en">\n<head>\n  <meta charset="UTF-8">\n  <meta name="viewport" content="width=device-width, initial-scale=1.0">\n  <title>Unreal Playground</title>\n</head>\n<body>\n  <div class="container">\n    <h1>Hello, World! ðŸš€</h1>\n    <p>Edit the code and see the magic happen...</p>\n  </div>\n</body>\n</html>',
      css: '/* CSS Styles */\nbody {\n  font-family: "Roboto", sans-serif;\n  margin: 0;\n  padding: 20px;\n  background: linear-gradient(135deg, #121432, #0a0a1a);\n  color: #e0e0ff;\n}\n\n.container {\n  max-width: 800px;\n  margin: 0 auto;\n  text-align: center;\n  padding: 40px 20px;\n}\n\nh1 {\n  font-family: "Orbitron", sans-serif;\n  color: #00aaff;\n  margin-bottom: 20px;\n  text-shadow: 0 0 10px rgba(0, 170, 255, 0.3);\n}\n\np {\n  font-size: 18px;\n  line-height: 1.6;\n}',
      javascript: '// JavaScript\nconsole.log("Welcome to Unreal Playground!");\n\ndocument.addEventListener("DOMContentLoaded", function() {\n  const heading = document.querySelector("h1");\n  heading.addEventListener("click", function() {\n    this.style.transform = "scale(1.1)";\n    setTimeout(() => {\n      this.style.transform = "scale(1)";\n    }, 200);\n    console.log("You clicked the heading!");\n  });\n});'
    };

    const snippets = {
      'hello-world': {
        html: '<!DOCTYPE html>\n<html>\n<head>\n  <title>Hello World</title>\n</head>\n<body>\n  <h1>Hello, World!</h1>\n  <p>Welcome to the Unreal Playground.</p>\n</body>\n</html>',
        css: 'body {\n  font-family: Arial, sans-serif;\n  text-align: center;\n  margin-top: 50px;\n  background: #f0f0f0;\n}\n\nh1 {\n  color: #333;\n}\n\np {\n  color: #666;\n}',
        js: 'console.log("Hello from the console!");'
      },
      // ... other snippets (same as before)
    };

    function initEditor() {
      editor.value = initialContent[currentLang];
      updatePreview();
      saveToHistory();
    }

    function updatePreview() {
      const html = editor.value;
      const doc = `
        <html>
          <head>
            <base target="_parent">
            <style id="user-css">${currentLang === 'css' ? html : initialContent.css}</style>
          </head>
          <body>
            ${currentLang === 'html' ? html : initialContent.html}
            <script>
              console.log = function(...args) {
                try {
                  window.parent.postMessage({
                    type: 'console',
                    level: 'log',
                    message: args.map(arg => 
                      typeof arg === 'object' ? JSON.stringify(arg) : String(arg)
                    ).join(' ')
                  }, '*');
                } catch (e) {}
              };
              console.error = console.warn = console.log;
            <\/script>
            <script>${currentLang === 'javascript' ? html : initialContent.js}<\/script>
          </body>
        </html>
      `;
      
      try {
        preview.srcdoc = doc;
      } catch (e) {
        console.error('Error updating preview:', e);
      }
    }

    function formatCode() {
      const value = editor.value;
      let formatted = '';
      let indent = 0;
      const lines = value.split('\n');
      
      lines.forEach(line => {
        const trimmed = line.trim();
        if (trimmed.startsWith('</') || trimmed.match(/^\s*}/)) indent = Math.max(0, indent - 1);
        if (trimmed) formatted += '  '.repeat(indent) + trimmed + '\n';
        else formatted += '\n';
        if (trimmed.match(/<[^\/].*>[^<>]*$/) || trimmed.match(/{$/)) indent++;
      });
      
      editor.value = formatted.trimEnd();
      saveToHistory();
      updatePreview();
      logToConsole('Code formatted', 'info');
    }

    function saveToHistory() {
      if (historyIndex < editorHistory.length - 1) {
        editorHistory = editorHistory.slice(0, historyIndex + 1);
      }
      
      editorHistory.push({ lang: currentLang, content: editor.value });
      if (editorHistory.length > 50) editorHistory.shift();
      historyIndex = editorHistory.length - 1;
      updateHistoryButtons();
    }

    function navigateHistory(step) {
      const newIndex = historyIndex + step;
      if (newIndex >= 0 && newIndex < editorHistory.length) {
        const state = editorHistory[newIndex];
        historyIndex = newIndex;
        
        if (state.lang !== currentLang) {
          currentLang = state.lang;
          updateTabs();
        }
        
        editor.value = state.content;
        updatePreview();
        updateHistoryButtons();
      }
    }

    function updateHistoryButtons() {
      undoBtn.disabled = historyIndex <= 0;
      redoBtn.disabled = historyIndex >= editorHistory.length - 1;
    }

    function logToConsole(message, level = 'info') {
      const entry = document.createElement('div');
      entry.className = `log-entry log-${level}`;
      entry.textContent = message;
      consoleEl.appendChild(entry);
      consoleEl.scrollTop = consoleEl.scrollHeight;
    }

    function clearConsoleLogs() {
      consoleEl.innerHTML = '';
      logToConsole('Console cleared', 'info');
    }

    function updateTabs() {
      tabs.forEach(tab => {
        tab.classList.toggle('active', tab.dataset.lang === currentLang);
      });
      editorMode.textContent = `${currentLang.toUpperCase()} Editor`;
    }

    function switchLanguage(lang) {
      initialContent[currentLang] = editor.value;
      currentLang = lang;
      updateTabs();
      editor.value = initialContent[currentLang];
      updatePreview();
      saveToHistory();
    }

    function setPreviewDevice(device) {
      deviceBtns.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.device === device);
      });
      
      const frame = document.querySelector('.preview-frame');
      frame.style.width = device === 'mobile' ? '375px' : 
                          device === 'tablet' ? '768px' : '100%';
      frame.style.margin = device === 'mobile' || device === 'tablet' ? '0 auto' : '0';
    }

    function loadSnippet(id) {
      const snippet = snippets[id];
      if (snippet) {
        Object.keys(snippet).forEach(lang => {
          initialContent[lang] = snippet[lang];
        });
        switchLanguage('html');
        editor.value = initialContent.html;
        updatePreview();
        saveToHistory();
        logToConsole(`Loaded snippet: ${id}`, 'info');
        snippetsPanel.classList.remove('open');
      }
    }

    // Event Listeners (same as before)
    runBtn.addEventListener('click', () => {
      updatePreview();
      logToConsole('Preview updated', 'info');
    });

    formatBtn.addEventListener('click', formatCode);

    saveBtn.addEventListener('click', () => {
      logToConsole('Code saved locally', 'info');
    });

    clearBtn.addEventListener('click', () => {
      if (confirm('Clear all code?')) {
        editor.value = '';
        saveToHistory();
        updatePreview();
        logToConsole('Editor cleared', 'info');
      }
    });

    undoBtn.addEventListener('click', () => navigateHistory(-1));
    redoBtn.addEventListener('click', () => navigateHistory(1));
    clearConsole.addEventListener('click', clearConsoleLogs);

    librariesBtn.addEventListener('click', () => {
      alert('Library manager would open here in full version.');
    });

    tabs.forEach(tab => {
      tab.addEventListener('click', () => switchLanguage(tab.dataset.lang));
    });

    deviceBtns.forEach(btn => {
      btn.addEventListener('click', () => setPreviewDevice(btn.dataset.device));
    });

    snippetsBtn.addEventListener('click', () => {
      snippetsPanel.classList.add('open');
    });

    closeSnippets.addEventListener('click', () => {
      snippetsPanel.classList.remove('open');
    });

    document.addEventListener('click', (e) => {
      if (!snippetsPanel.contains(e.target) && !snippetsBtn.contains(e.target)) {
        snippetsPanel.classList.remove('open');
      }
    });

    document.querySelectorAll('.snippet-item').forEach(item => {
      item.addEventListener('click', () => loadSnippet(item.dataset.snippet));
    });

    editor.addEventListener('input', () => {
      saveToHistory();
      clearTimeout(window.previewTimeout);
      window.previewTimeout = setTimeout(updatePreview, 500);
    });

    window.addEventListener('message', (event) => {
      if (event.data.type === 'console') {
        logToConsole(event.data.message, event.data.level);
      }
    });

    document.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 's') {
        e.preventDefault();
        saveBtn.click();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        runBtn.click();
      }
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undoBtn.click();
      }
      if ((e.ctrlKey || e.metaKey) && (e.key === 'Z' || (e.shiftKey && e.key === 'z'))) {
        e.preventDefault();
        redoBtn.click();
      }
    });

    initEditor();
    updateHistoryButtons();
    setPreviewDevice('desktop');
  </script>
</body>
</html>